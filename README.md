# Followers ETL Service
## Краткое описание
ETL сервис, который синхронизирует записи .csv таблицы и базы данных (PostgreSQL) через cron-планировщик.

Для синхронизации базы используется пул воркеров (ants), каждый из которых параллельно обратывает определенное количество записей, полученных из главной горутины) и, используя множественную вставку (bulk_insert), вставляет записи в таблицу `staging_followers`, с определенным `load_id`.
В случае успеха, в служебной таблице: `etl_info_schema.table_status`, появляется запись с временной меткой последней синхронизации и далее происходит атомарное слияние в таблицу `followers`, “просроченные” записи, не подвергшиеся обновлению (на основании временной метки `last_activity` таблицы `etl_info_schema.table_status)` удаляются. На каждом шаге используется паттерн компенсации, который позволяет откатить состояние системы в случае ошибки.

### Таблицы
#### Подписчик (`public.followers`  таблица в PostgreSQL).
| Название    | Тип          | Описание                |
|-------------|--------------|-------------------------|
| email       | VARCHAR(255) | Email пользователя      |
| full_name   | VARCHAR(255) | Полное имя пользователя |
| modified_at | TIMESTAMP    | Служебное поле          |
#### Промежуточная таблица для подписчиков (`public.staging_followers` таблица в PostgreSQL).

| Название  | Тип          | Описание                                        |
|-----------|--------------|-------------------------------------------------|
| email     | VARCHAR(255) | Email пользователя                              |
| full_name | VARCHAR(255) | Полное имя пользователя                         |
| load_id   | UUID         | Служебное поле, отражающее id рабочего процесса |

#### Таблица состояния синхронизации (`etl_info_schema.table_status`таблица в PostgreSQL).

| Название      | Тип         | Описание                                         |
|---------------|-------------|--------------------------------------------------|
| id            | SERIAL      | Численный идентификатор                          |
| table_name    | VARCHAR(64) | Название таблицы                                 |
| last_activity | TIMESTAMP   | Когда в последний раз, происходила синхронизация |

## Быстрый старт
1. Клонировать репозиторий:
```bash
git clone https://github.com/amr0ny/followers-etl-service
cd followers-etl-service
```
2. Создать `.env` файл в корне проекта и заполнить его переменными среды (пример – `.env.example` в корне проекта)
3. Поместить csv-файл в `./tables` относительно корневой директории проекта и указать его имя в переменных среды
4. Запустите `docker-compose`:
```bash
docker-compose up -d 
```

## Переменные окружения

| Название               | Тип    | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
|------------------------|--------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| BATCH_SIZE             | int    | Количество записей из csv-таблицы, которое обрабатывается одним воркером. Очень большие значения не оптимальны, поскольку, собирая большое количество строк за раз, главный воркер заставляет простаивать воркеров из пула. По умолчанию – 75.                                                                                                                                                                                                                                                  |
| CSV_FILE               | string | Путь к csv-таблице,  таблица  должна находиться в директории ./tables относительно корня проекта. Обязательная переменная.                                                                                                                                                                                                                                                                                                                                                                      |
| DB_MIN_CONNS           | int    | Минимальное предварительно установленное количество подключений, которые не закрываются даже если нет запросов. Из-за издержек использования все время открытых подключений, для задач крон исполняющихся с интервалом в минуту лучше указывать не более 2-3. По умолчанию – 0.                                                                                                                                                                                                                 |
| DB_MAX_CONNS           | int    | Максимальное количество подключений пула подключений к базе данных (не рекомендуется ставить больше 70% от `max_connections` ограничения в PostgreSQL.). По умолчанию – 30                                                                                                                                                                                                                                                                                                                      |
| WORKER_POOL_GOROUTINES | int    | Размер пула воркеров (горутин). Выбор зависит от количества ядер, не должен превышать DB_MAX_CONNS. По умолчанию – 16.                                                                                                                                                                                                                                                                                                                                                                          |
| CRON_SCHEDULE          | string | Переменная CRON_SCHEDULE задаёт интервал запуска ETL-задачи в формате cron. Поддерживаются как стандартные cron-выражения (например, 0 3 * * * — каждый день в 03:00), так и интервальные выражения вида @every 6h (каждые 6 часов). Допустимы также значения @hourly, @daily, @weekly и т.п. Формат соответствует синтаксису библиотеки robfig/cron v3. Подробнее [документация](https://pkg.go.dev/github.com/robfig/cron/v3#hdr-CRON_Expression_Format).<br/>По умолчанию используется @every 24h |